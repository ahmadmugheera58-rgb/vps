name: BugHunter-VPS-V3
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
    - name: Install Dependencies
      run: sudo apt update && sudo apt install -y wget unzip openssh-server curl jq

    - name: Setup Ngrok
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.zip -O ngrok.zip
        unzip -o ngrok.zip
        chmod +x ngrok
        # If this line fails, your Secret is likely missing in GitHub
        ./ngrok config add-authtoken "${{ secrets.NGROK_AUTH_TOKEN }}"

    - name: SSH Config
      run: |
        echo "root:toor123" | sudo chpasswd
        sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
        sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo systemctl restart ssh

    - name: Start Tunnel
      run: |
        ./ngrok tcp 22 --log=stdout > ngrok.log 2>&1 &
        sleep 15
        
        # Grab the URL directly from the local Ngrok API
        FULL_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
        
        if [ "$FULL_URL" = "null" ]; then
          echo "ERROR: Tunnel not found. Log dump:"
          cat ngrok.log
          exit 1
        fi

        echo "=========================================="
        echo "SUCCESS! CONNECT COMMAND:"
        echo "ssh root@${FULL_URL//tcp:\/\//} "
        echo "Password: toor123"
        echo "=========================================="
        
        # Prevent the runner from exiting
        while true; do sleep 60; done
