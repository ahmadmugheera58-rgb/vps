name: BugHunter-Cloudflare
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Install Cloudflared & SSH
      run: |
        sudo apt update && sudo apt install -y wget openssh-server
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb
        
    - name: Configure Root Access
      run: |
        echo "root:toor123" | sudo chpasswd
        sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
        sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo systemctl restart ssh

    - name: Start Cloudflare Tunnel
      run: |
        # This creates a tunnel and prints the random URL to the logs
        cloudflared tunnel --url ssh://localhost:22 > cf.log 2>&1 &
        sleep 10
        echo "======================================================"
        echo "           CLOUDFLARE SSH ACCESS                      "
        echo "======================================================"
        grep -o 'https://[-a-z0-9.]*trycloudflare.com' cf.log | head -n 1
        echo "======================================================"
        echo "PASSWORD: toor123"
        echo "======================================================"
        
        # Keep alive
        while true; do sleep 300; done
